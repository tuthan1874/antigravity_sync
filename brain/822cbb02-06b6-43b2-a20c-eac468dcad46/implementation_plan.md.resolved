# Cloudflare R2 Migration Plan

## Goal
Replace Supabase Storage with Cloudflare R2 for storing avatars, documents, and attachments. This will likely reduce costs and provide more control over file distribution.

## User Review Required
> [!IMPORTANT]
> You must provide the following Cloudflare R2 credentials in your [.env.local](file:///e:/TDC_App/TDGAMES_App/HRM/source/.env.local) file:
> - `R2_ACCOUNT_ID`: Your Cloudflare Account ID.
> - `R2_ACCESS_KEY_ID`: R2 Access Key ID.
> - `R2_SECRET_ACCESS_KEY`: R2 Secret Access Key.
> - `R2_BUCKET_NAME`: The name of your R2 bucket.
> - `R2_PUBLIC_URL`: (Optional) The public domain for your bucket (e.g., `https://files.yourdomain.com`), used for public assets like avatars.

## Proposed Changes

### 1. Dependencies [NEW]
- Install `@aws-sdk/client-s3` and `@aws-sdk/s3-request-presigner` to interact with R2 (which is S3-compatible).

### 2. Configuration [NEW]
- Create `lib/r2.ts` to initialize the S3 client using R2 credentials.
- Implement helper functions:
  - `uploadFile(key, body, contentType)`
  - `deleteFile(key)`
  - `getSignedUrl(key, expiresIn)`

### 3. Refactoring Integration Points [MODIFY]

#### [lib/avatar-utils.ts](file:///e:/TDC_App/TDGAMES_App/HRM/source/lib/avatar-utils.ts)
- **Current**: Uploads to Supabase `avatar` bucket.
- **New**: Uploads to R2. Returns the R2 key or public URL.
- **Impact**: Avatar display components may need to handle R2 URLs. [getAvatarUrl](file:///e:/TDC_App/TDGAMES_App/HRM/source/lib/avatar-utils.ts#3-34) function will simply append the `R2_PUBLIC_URL` if configured, or use presigned URLs if private.

#### [app/api/expense-requests/upload/route.ts](file:///e:/TDC_App/TDGAMES_App/HRM/source/app/api/expense-requests/upload/route.ts)
- **Current**: Uploads to Supabase `expense-attachments` bucket.
- **New**: Uploads to R2 using `PutObjectCommand`.

#### [app/api/storage/sign-url/route.ts](file:///e:/TDC_App/TDGAMES_App/HRM/source/app/api/storage/sign-url/route.ts)
- **Current**: Generates Supabase signed URL.
- **New**: Generates R2 presigned URL using `getSignedUrl` from `@aws-sdk/s3-request-presigner`.

### 4. Verification Plan
- **Manual Test**: Upload a new avatar or expense document.
- **Manual Test**: Verify that the file appears in the R2 bucket (via Cloudflare dashboard or by checking the returned URL).
- **Manual Test**: Verify that the file can be viewed/downloaded.

## Migration Note
> [!NOTE]
> Existing files in Supabase Storage will **NOT** be automatically moved to R2 by this plan. You will need to manually migrate them or keep Supabase as a fallback for old files if critical. This plan focuses on **new** uploads.
